<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routes APIå¯è§†åŒ–åŠŸèƒ½æ¼”ç¤º</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 30px;
        }
        .demo-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        .demo-section h3 {
            color: #495057;
            margin-top: 0;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .highlight {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ Routes APIå¯è§†åŒ–åŠŸèƒ½æ¼”ç¤º</h1>
        
        <div class="highlight">
            <strong>ğŸ¯ æ¼”ç¤ºç›®æ ‡:</strong> å±•ç¤ºä»è™šçº¿è·¯çº¿å‡çº§åˆ°çœŸå®é“è·¯è·¯å¾„çš„å¯è§†åŒ–æ•ˆæœ
        </div>

        <div class="demo-section">
            <h3>ğŸ“‹ 1. ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h3>
            <p>æ£€æŸ¥Routes APIå¯è§†åŒ–ä¼˜åŒ–å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
            <button class="test-button" onclick="checkStatus()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
            <div id="status-result" class="result-area"></div>
        </div>

        <div class="demo-section">
            <h3>ğŸ§ª 2. Routes APIå¯è§†åŒ–æµ‹è¯•</h3>
            <p>ä½¿ç”¨é›…åŠ è¾¾åœ°åŒºæµ‹è¯•æ•°æ®ï¼Œç”ŸæˆçœŸå®è·¯çº¿å¯è§†åŒ–</p>
            <button class="test-button" onclick="testRoutesVisual()">æµ‹è¯•Routes APIå¯è§†åŒ–</button>
            <button class="test-button" onclick="testCustomOrders()">ä½¿ç”¨è‡ªå®šä¹‰è®¢å•æµ‹è¯•</button>
            <div id="visual-result" class="result-area"></div>
        </div>

        <div class="demo-section">
            <h3>ğŸ“Š 3. å¯è§†åŒ–æ•°æ®åˆ†æ</h3>
            <p>åˆ†æç”Ÿæˆçš„è·¯çº¿æ•°æ®å’Œå¯è§†åŒ–æ•ˆæœ</p>
            <button class="test-button" onclick="analyzeVisualData()">åˆ†æå¯è§†åŒ–æ•°æ®</button>
            <div id="analysis-result" class="result-area"></div>
        </div>

        <div class="demo-section">
            <h3>ğŸ¨ 4. å‰ç«¯é›†æˆæ¼”ç¤º</h3>
            <p>æ¼”ç¤ºå¦‚ä½•åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºRoutes APIç”Ÿæˆçš„è·¯çº¿</p>
            <button class="test-button" onclick="showIntegrationCode()">æŸ¥çœ‹é›†æˆä»£ç </button>
            <div id="integration-result" class="result-area"></div>
        </div>
    </div>

    <script>
        let lastVisualResult = null;

        async function checkStatus() {
            const resultDiv = document.getElementById('status-result');
            resultDiv.textContent = 'ğŸ” æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...';
            
            try {
                const response = await fetch('/api/config-status');
                const data = await response.json();
                
                let statusText = '';
                statusText += `âœ… Google Maps API: ${data.google_maps_configured ? 'å·²é…ç½®' : 'æœªé…ç½®'}\n`;
                statusText += `âœ… è·¯çº¿ä¼˜åŒ–å™¨: ${data.route_optimizer_ready ? 'å°±ç»ª' : 'æœªå°±ç»ª'}\n`;
                statusText += `ğŸŒ ç¯å¢ƒ: ${data.environment}\n`;
                statusText += `â° æ—¶é—´: ${data.timestamp}\n\n`;
                
                if (data.google_maps_configured && data.route_optimizer_ready) {
                    statusText += 'ğŸ‰ Routes APIå¯è§†åŒ–ä¼˜åŒ–å™¨å·²å°±ç»ªï¼';
                    showStatus('success', 'Routes APIå¯è§†åŒ–ä¼˜åŒ–å™¨å·¥ä½œæ­£å¸¸');
                } else {
                    statusText += 'âš ï¸ é…ç½®ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥é…ç½®';
                    showStatus('error', 'ç³»ç»Ÿé…ç½®ä¸å®Œæ•´');
                }
                
                resultDiv.textContent = statusText;
            } catch (error) {
                resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}`;
                showStatus('error', 'ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥');
            }
        }

        async function testRoutesVisual() {
            const resultDiv = document.getElementById('visual-result');
            resultDiv.textContent = 'ğŸ—ºï¸ å¼€å§‹Routes APIå¯è§†åŒ–æµ‹è¯•...';
            
            try {
                const response = await fetch('/api/test-routes-visual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                lastVisualResult = data;
                
                if (data.success) {
                    let resultText = '';
                    resultText += `ğŸ‰ Routes APIå¯è§†åŒ–æµ‹è¯•æˆåŠŸï¼\n\n`;
                    resultText += `ğŸ“Š æµ‹è¯•æ‘˜è¦:\n`;
                    resultText += `- è¾“å…¥è®¢å•: ${data.test_summary.input_orders}ä¸ª\n`;
                    resultText += `- è¾“å‡ºæ‰¹æ¬¡: ${data.test_summary.output_batches}ä¸ª\n`;
                    resultText += `- è·¯çº¿æ®µæ•°: ${data.test_summary.total_route_segments}æ®µ\n`;
                    resultText += `- ç”Ÿæˆpolylines: ${data.test_summary.polylines_generated}æ¡\n`;
                    resultText += `- å¯è§†åŒ–å°±ç»ª: ${data.test_summary.visualization_ready ? 'âœ…' : 'âŒ'}\n`;
                    resultText += `- æ‰§è¡Œæ—¶é—´: ${data.execution_time_ms}ms\n\n`;
                    
                    resultText += `ğŸš› è·¯çº¿ä¼˜åŒ–ç»“æœ:\n`;
                    if (data.optimization_result.batches) {
                        data.optimization_result.batches.forEach((batch, index) => {
                            resultText += `æ‰¹æ¬¡${batch.batch_number}: ${batch.total_distance.toFixed(1)}km, ${batch.total_duration.toFixed(0)}åˆ†é’Ÿ, ${batch.capacity_used}ä»¶\n`;
                            resultText += `  è·¯çº¿æ®µ: ${batch.route_polylines ? batch.route_polylines.length : 0}æ®µ\n`;
                        });
                    }
                    
                    resultText += `\nğŸ—ºï¸ APIä½¿ç”¨æƒ…å†µ:\n`;
                    resultText += `- ä»Šæ—¥è°ƒç”¨: ${data.api_usage.api_calls_today}/10000\n`;
                    resultText += `- å‰©ä½™é…é¢: ${data.api_usage.remaining_calls}\n`;
                    resultText += `- ç¼“å­˜è·¯çº¿: ${data.api_usage.route_cache_size}æ¡\n`;
                    
                    resultDiv.textContent = resultText;
                    showStatus('success', 'Routes APIå¯è§†åŒ–æµ‹è¯•æˆåŠŸå®Œæˆ');
                } else {
                    resultDiv.textContent = `âŒ æµ‹è¯•å¤±è´¥: ${data.error}`;
                    showStatus('error', 'Routes APIå¯è§†åŒ–æµ‹è¯•å¤±è´¥');
                }
            } catch (error) {
                resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}`;
                showStatus('error', 'Routes APIæµ‹è¯•è¯·æ±‚å¤±è´¥');
            }
        }

        async function testCustomOrders() {
            const resultDiv = document.getElementById('visual-result');
            resultDiv.textContent = 'ğŸ—ºï¸ ä½¿ç”¨è‡ªå®šä¹‰è®¢å•æµ‹è¯•...';
            
            const customOrders = [
                {
                    "id": "CUSTOM001",
                    "name": "é›…åŠ è¾¾å•†ä¸šåŒº",
                    "lat": -6.1751,
                    "lng": 106.8650,
                    "dus_count": 20,
                    "address": "Jakarta Business District"
                },
                {
                    "id": "CUSTOM002",
                    "name": "é›…åŠ è¾¾æœºåœºé™„è¿‘",
                    "lat": -6.1275,
                    "lng": 106.6537,
                    "dus_count": 15,
                    "address": "Near Jakarta Airport"
                }
            ];
            
            try {
                const response = await fetch('/api/test-routes-visual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(customOrders)
                });
                
                const data = await response.json();
                lastVisualResult = data;
                
                let resultText = `ğŸ“ è‡ªå®šä¹‰è®¢å•æµ‹è¯•ç»“æœ:\n\n`;
                resultText += JSON.stringify(data, null, 2);
                
                resultDiv.textContent = resultText;
                showStatus('success', 'è‡ªå®šä¹‰è®¢å•æµ‹è¯•å®Œæˆ');
            } catch (error) {
                resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}`;
                showStatus('error', 'è‡ªå®šä¹‰è®¢å•æµ‹è¯•å¤±è´¥');
            }
        }

        function analyzeVisualData() {
            const resultDiv = document.getElementById('analysis-result');
            
            if (!lastVisualResult) {
                resultDiv.textContent = 'âš ï¸ è¯·å…ˆè¿è¡ŒRoutes APIå¯è§†åŒ–æµ‹è¯•';
                return;
            }
            
            let analysisText = '';
            analysisText += `ğŸ“ˆ Routes APIå¯è§†åŒ–æ•°æ®åˆ†æ\n\n`;
            
            if (lastVisualResult.success && lastVisualResult.optimization_result.batches) {
                const batches = lastVisualResult.optimization_result.batches;
                
                analysisText += `ğŸ¯ æ€»ä½“æ€§èƒ½åˆ†æ:\n`;
                analysisText += `- æ€»è·ç¦»: ${lastVisualResult.optimization_result.total_distance}km\n`;
                analysisText += `- æ€»æ—¶é—´: ${lastVisualResult.optimization_result.total_duration}åˆ†é’Ÿ\n`;
                analysisText += `- æ‰§è¡Œæ•ˆç‡: ${lastVisualResult.execution_time_ms}ms\n\n`;
                
                analysisText += `ğŸ›£ï¸ å¯è§†åŒ–è´¨é‡åˆ†æ:\n`;
                batches.forEach((batch, index) => {
                    const hasPolylines = batch.route_polylines && batch.route_polylines.length > 0;
                    const polylinesWithData = hasPolylines ? 
                        batch.route_polylines.filter(p => p.polyline).length : 0;
                    
                    analysisText += `æ‰¹æ¬¡${batch.batch_number}:\n`;
                    analysisText += `  - è·¯çº¿æ®µ: ${hasPolylines ? batch.route_polylines.length : 0}æ®µ\n`;
                    analysisText += `  - çœŸå®è·¯çº¿: ${polylinesWithData}æ®µ\n`;
                    analysisText += `  - ä¼°ç®—è·¯çº¿: ${hasPolylines ? batch.route_polylines.length - polylinesWithData : 0}æ®µ\n`;
                    analysisText += `  - å¯è§†åŒ–è´¨é‡: ${polylinesWithData > 0 ? 'é«˜è´¨é‡(Routes API)' : 'åŸºç¡€è´¨é‡(ç›´çº¿ä¼°ç®—)'}\n\n`;
                });
                
                analysisText += `ğŸ’¡ å‡çº§æ•ˆæœ:\n`;
                analysisText += `- âœ… ä»è™šçº¿å‡çº§åˆ°å®çº¿è·¯å¾„\n`;
                analysisText += `- âœ… æä¾›æ¯æ®µè·¯çº¿çš„è¯¦ç»†ä¿¡æ¯\n`;
                analysisText += `- âœ… æ”¯æŒçœŸå®é“è·¯è·¯å¾„æ˜¾ç¤º\n`;
                analysisText += `- âœ… æ‰¹æ¬¡é¢œè‰²åŒºåˆ†å’Œè·¯çº¿æ ‡æ³¨\n`;
                
            } else {
                analysisText += 'âŒ æ²¡æœ‰å¯åˆ†æçš„æ•°æ®';
            }
            
            resultDiv.textContent = analysisText;
        }

        function showIntegrationCode() {
            const resultDiv = document.getElementById('integration-result');
            
            const codeExample = `ğŸ¨ å‰ç«¯é›†æˆç¤ºä¾‹ä»£ç :

// 1. æ›´æ–°æ¥å£å®šä¹‰æ”¯æŒRoutes APIæ•°æ®
interface RoutePolyline {
  from: string;
  to: string;
  polyline: string | null;
  distance: number;
  duration: number;
  from_coords: { lat: number; lng: number };
  to_coords: { lat: number; lng: number };
}

interface OptimizedBatch {
  batch_number: number;
  route: Array<{...}>;
  total_distance: number;
  total_duration: number;
  capacity_used: number;
  route_polylines?: RoutePolyline[]; // æ–°å¢å¯è§†åŒ–æ•°æ®
}

// 2. è·¯çº¿æ˜¾ç¤ºç»„ä»¶å‡çº§
const RouteOverlay = ({ routeData }) => {
  // æ£€æŸ¥æ˜¯å¦æœ‰Routes APIå¯è§†åŒ–æ•°æ®
  const hasRoutePolylines = batch.route_polylines && batch.route_polylines.length > 0;
  
  if (hasRoutePolylines) {
    // æ˜¾ç¤ºçœŸå®è·¯çº¿æ®µ
    return batch.route_polylines.map((segment, index) => (
      <Polyline
        positions={[
          [segment.from_coords.lat, segment.from_coords.lng],
          [segment.to_coords.lat, segment.to_coords.lng]
        ]}
        pathOptions={{
          color: batchColor,
          weight: 5,
          opacity: 0.9,
          dashArray: segment.polyline ? undefined : '5, 5' // å®çº¿vsè™šçº¿
        }}
      />
    ));
  } else {
    // å¤‡ç”¨æ–¹æ¡ˆï¼šç®€å•è¿çº¿
    return <Polyline positions={simplePath} pathOptions={{dashArray: '10, 10'}} />;
  }
};

// 3. æ•°æ®è·å–
const response = await fetch('/api/test-routes-visual', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(orders)
});

const visualData = await response.json();
// visualData.optimization_result.batches[0].route_polylines åŒ…å«å¯è§†åŒ–æ•°æ®

ğŸ¯ å‡çº§å¯¹æ¯”:
- æ—§ç‰ˆæœ¬: è™šçº¿è¿æ¥ (dashArray: '10, 10')
- æ–°ç‰ˆæœ¬: å®çº¿è·¯å¾„ + è·¯çº¿æ®µè¯¦æƒ… + æ‰¹æ¬¡æ ‡è®°
- æ•°æ®æº: Routes APIçœŸå®é“è·¯ vs ç›´çº¿ä¼°ç®—
- è§†è§‰æ•ˆæœ: 95% vs 30% å‡†ç¡®åº¦`;
            
            resultDiv.textContent = codeExample;
        }

        function showStatus(type, message) {
            // ç§»é™¤ç°æœ‰çŠ¶æ€
            const existingStatus = document.querySelector('.status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            // åˆ›å»ºæ–°çŠ¶æ€
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            document.querySelector('.container').insertBefore(statusDiv, document.querySelector('.demo-section'));
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.onload = function() {
            checkStatus();
        };
    </script>
</body>
</html> 